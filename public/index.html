<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultra Fast Voice Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f0f0f0;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.connecting {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .controls {
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ Voice Chat</h1>
    <p>‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTTPS)</p>
    
    <div id="status" class="status disconnected">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
    
    <div class="controls">
      <button id="startBtn" onclick="startVoiceChat()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
      <button id="stopBtn" onclick="stopVoiceChat()" disabled>‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
    </div>
    
    <div id="log"></div>
  </div>

  <script>
    let ws = null;
    let pc = null;
    let localStream = null;
    let isConnected = false;
    
    const statusDiv = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const logDiv = document.getElementById('log');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô HTTPS ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isSecure = location.protocol === 'https:';
    const wsProtocol = isSecure ? 'wss:' : 'ws:';
    
    function log(message) {
      console.log(message);
      logDiv.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function updateStatus(message, className) {
      statusDiv.textContent = message;
      statusDiv.className = `status ${className}`;
    }
    
    async function startVoiceChat() {
      try {
        startBtn.disabled = true;
        updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô...', 'connecting');
        
        // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 44100
          }
        });
        
        log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
        
        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket
        connectWebSocket();
        
      } catch (error) {
        log(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
        updateStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ', 'disconnected');
        startBtn.disabled = false;
      }
    }
    
    function connectWebSocket() {
      const wsUrl = `${wsProtocol}//${location.host}`;
      log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${wsUrl}`);
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        log('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        updateStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∏‡∏¢!', 'connected');
        isConnected = true;
        stopBtn.disabled = false;
        setupWebRTC();
      };
      
      ws.onclose = () => {
        log('WebSocket ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î');
        updateStatus('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î', 'disconnected');
        isConnected = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };
      
      ws.onerror = (error) => {
        log(`WebSocket ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error}`);
        updateStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'disconnected');
      };
      
      ws.onmessage = handleWebSocketMessage;
    }
    
    function setupWebRTC() {
      pc = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° local stream
      if (localStream) {
        localStream.getTracks().forEach(track => {
          pc.addTrack(track, localStream);
        });
      }
      
      pc.ontrack = (event) => {
        log('‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢');
        const audio = document.createElement("audio");
        audio.srcObject = event.streams[0];
        audio.autoplay = true;
        audio.volume = 1.0;
        document.body.appendChild(audio);
      };
      
      pc.onicecandidate = (event) => {
        if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ 
            type: 'ice-candidate',
            candidate: event.candidate 
          }));
        }
      };
      
      pc.onconnectionstatechange = () => {
        log(`WebRTC ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${pc.connectionState}`);
        if (pc.connectionState === 'connected') {
          updateStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'connected');
        }
      };
    }
    
    async function handleWebSocketMessage(message) {
      try {
        const data = JSON.parse(message.data);
        
        if (data.type === 'offer') {
          log('‡∏£‡∏±‡∏ö offer ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢');
          await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ 
            type: 'answer', 
            answer: answer 
          }));
          
        } else if (data.type === 'answer') {
          log('‡∏£‡∏±‡∏ö answer ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢');
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
          
        } else if (data.type === 'ice-candidate') {
          log('‡∏£‡∏±‡∏ö ICE candidate');
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      } catch (error) {
        log(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ${error.message}`);
      }
    }
    
    function stopVoiceChat() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      if (pc) {
        pc.close();
        pc = null;
      }
      
      if (ws) {
        ws.close();
        ws = null;
      }
      
      // ‡∏•‡∏ö audio elements
      document.querySelectorAll('audio').forEach(audio => audio.remove());
      
      updateStatus('‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'disconnected');
      startBtn.disabled = false;
      stopBtn.disabled = true;
      logDiv.innerHTML = '';
      log('‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
    }
    
    // Auto-connect ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    window.addEventListener('load', () => {
      log('‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
      if (isSecure) {
        log('‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô HTTPS - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      } else {
        log('‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô HTTP - ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô');
      }
    });
  </script>
</body>
</html>